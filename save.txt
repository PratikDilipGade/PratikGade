import { Resend } from 'resend';

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).send('Method Not Allowed');

  const event = req.body;

  if (event.event_type !== 'PAYMENT.CAPTURE.COMPLETED') {
    return res.status(200).send('Ignored');
  }

  const buyerEmail = event.resource.payer.email_address;
  const productName = 'Your Digital Product';
  const downloadUrl = 'https://your-site.com/downloads/product.zip';

  try {
    const resend = new Resend(process.env.RESEND_API_KEY);

    await resend.emails.send({
      from: 'Your Store <noreply@yourdomain.com>',
      to: buyerEmail,
      subject: `Your purchase: ${productName}`,
      html: `
        <p>Thanks for your purchase!</p>
        <p><a href="${downloadUrl}">Click here to download your product</a></p>
      `,
    });

    res.status(200).send('Email sent successfully!');
  } catch (error) {
    console.error('Email send error:', error);
    res.status(500).send('Error sending email');
  }
}
